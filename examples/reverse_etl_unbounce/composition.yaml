name: reverse_etl_unbounce
description: Reverse ETL ingestion from storage to rdbms
dag_parameters:
    dag_id: reverse_etl_unbouncee
    schedule_interval: 0 0 * * *
    start_date:
      year: 2022
      month: 6
      day: 4
    end_date:
      year: 2022
      month: 6
      day: 5
    description: Reverse ETL incremental ingestion from storage to rdbms base 
    default_args:
      owner: debussy
    tags:
      - framework:debussy_concert
      - project:modular-aileron-191222
      - destiny:rdbms
      - type:reverse_etl
      - tier:5
extraction_movements:
  - name: extract_to_mysql
    reverse_etl_query: >
      SELECT *     
      FROM `dotzcloud-datalabs-analytics.UNBOUNCE.vw_unbounce_leads` WHERE name_campain = "Novo Varejo LP Cadastro" AND DATE(created_at_lead) = DATE('{{ execution_date }}') 
      #novaconversao
    reverse_etl_dataset_partition_type: DAY
    reverse_etl_dataset_partition_field: created_at_lead
    extract_query_from_temp: >
      SELECT * 
      FROM `{reverse_etl_table_uri}`
      WHERE created_at_lead=TIMESTAMP('{{{{ execution_date }}}}')
      QUALIFY ROW_NUMBER() OVER (PARTITION BY created_at_lead) = 1
    #output_config:
    #  format: SQL
    #file_name: retl_data_{{ execution_date }}.sql
    #command_type: DML
      #adicionar secret para conex√£o com a base de destino
      #adicionar queru de inclusao do registro na origem
    output_config:
      format: SQL
      file_name: retl_data_{{ execution_date }}.sql
      command_type: DML
      field_delimiter: ','
    destination_type: not_used_yet
    destination_object_path: gs://autodelete_dev_bucket/retl_unbounce/extract_to_mysql/retl_unbounce_{{ execution_date }}.sql
    #destination_object_path: gs://autodelete_dev_bucket/retl_unbounce/unbounce_insert_{{ execution_date }}.sql
    gcp_connection_id: google_cloud_default
    destination_connection_id: google_cloud_default
    #destination_connection_id: unbounce_connection_id


